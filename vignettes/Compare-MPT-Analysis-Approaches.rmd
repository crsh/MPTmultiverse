---
title: "Compare MPT Analysis Approaches"
author: "Marius Barth"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Compare MPT Analysis Approaches}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE
  , comment = "#>"
  , warning = FALSE
  , message = FALSE
  , cache = TRUE
)
```

# Prerequisites

First of all, make sure that you have installed the *latest* version of all necessary `R` packages *and* of `JAGS`.
To install `JAGS`, go to [mcmc-jags.sourceforge.net](http://mcmc-jags.sourceforge.net/) and follow installation instructions.
After that, install or update the required packages.

```{r install-packages, eval = FALSE}
required <- c(
  "devtools"
  , "tidyr"
  , "dplyr"
  , "tibble"
  , "rlang"
  , "reshape2"
  , "ggplot2"
  , "MPTinR"
  , "TreeBUGS"
  , "runjags"
  , "purrr"
  , "readr"
  , "broom"
)

install.packages(required, repos = "https://cloud.r-project.org")
devtools::install_github("methexp/mpt.comparison")
```



## Example 1: Bayen & Kuhlmann (2011)



```{r model-and-data}
# load packages:
library("mpt.comparison")
runjags.options(silent.jags = TRUE, silent.runjags = TRUE)

# Make sure that working directory is correct via either:
# - setwd() / getwd()
# - Rstudio->Sessions->Set Working Directory->'To Source File Location'


# ------------------------------------------------------------------------------
# MPT model definition & Data

EQN_FILE <- "2HTSM_Submodel4.eqn"
DATA_FILE <- "Kuhlmann_dl7.csv"  


### if .csv format uses semicolons ";" (German format):
data <- read.csv2(DATA_FILE, fileEncoding = "UTF-8-BOM")
### if .csv format uses commata "," (international format):
# data <- read.csv(DATA_FILE, fileEncoding = "UTF-8-BOM")

head(data)
plotFreq(data, boxplot = FALSE, eqn = EQN_FILE)

### Optional:
### (A) add a person identifier if missing in data [uncomment if necessary]
# data$Subject <- 1:nrow(data)

### Optional:
### (B) add a dummy variable if data do not contain a between-subject factor  [uncomment if necessary]
# data$ExpCond <- "no_condition"

COL_ID <- "Subject"         # name of the variable encoding subject ID
COL_CONDITION <- "ExpCond"  # name of the variable encoding group membership

# NOTE: experimental condition should be labeled meaningfully!
unique(data[,COL_CONDITION])
data[,COL_CONDITION] <- factor(data[,COL_CONDITION],
                               levels = c(1:2),
                               labels = c("no_load", "load"))

### check input data frame
head(data)
```

### Options

Every time the package `mpt.comparison` is loaded, it automatically sets some defaults for model estimation, usage of multiple processor cores, 
number of posterior predictive samples, etc. By calling `mpt_options()` without any parameters, you can inspect these default values.
If you want to change them call, `mpt_options` with the respective parameter specified, i.e. `mpt_options(n.iter = 1000)`.
For testing purposes you can also specify `mpt_options("test")`, which is a shorthand for setting fast, but highly unreliable settings.

```{r options}
# How to change a single option:
mpt_options(n.iter = 1000)
# How to set all options for testing (uncomment for serious calculations):
mpt_options("test")
mpt_options(save_models = TRUE)
# List all options that were set for the different analysis approaches:
mpt_options()
```

### Estimation

The next lines of code do the basic model estimation---if everything is set up correctly,
these should remain unchanged.

```{r analysis, eval = FALSE}
res_mptinr <- mpt_mptinr(dataset = DATA_FILE, data = data, model = EQN_FILE,
                         col_id = COL_ID, col_condition = COL_CONDITION)

res_treebugs <- map(c("simple", "simple_pooling", "trait", "beta", "trait_uncorrelated"),
                    mpt_treebugs_safe, 
                    dataset = DATA_FILE, data = data, model = EQN_FILE,
                    col_id = COL_ID, col_condition = COL_CONDITION)

results <- bind_rows(res_mptinr, res_treebugs)
```


### Post-processing of Results

```{r results, eval = FALSE}
# print convergence results
check_results(results)

used_options <- getOption("mpt.comparison")
# store results
save(
  results
  , data
  , EQN_FILE
  , DATA_FILE
  , used_options
  , file = "results.RData"
)

write_check_results(paste0(EQN_FILE, "-", DATA_FILE), results)
plot_results(results, save = TRUE)
```

